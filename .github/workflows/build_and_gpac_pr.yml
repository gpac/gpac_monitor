name: build and copy to gpac
run-name: build and copy to gpac

on:
  push:
    branches:
      - release
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install and Build
        run: |
          pnpm install
          pnpm build

      - name: Checkout GPAC Repo
        uses: actions/checkout@v4
        with:
          repository: gpac/gpac
          token: ${{ secrets.GPAC_MONITOR_BUILDBOT }}
          path: gpac

      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.GPAC_MONITOR_BUILDBOT }}
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B)

          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          BRANCH_NAME="gpac-monitor-$SHORT_SHA"
          TARGET_DIR="share/scripts/rmt"

          # PR body
          cat <<EOF > pr_description.md
          ## ðŸš€ GPAC Monitor release

          This PR was automatically generated.

          **Details:**
          - **Triggered by commit:** [\`$SHORT_SHA\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          - **Workflow logs:** [run ${{ github.run_id }}]($RUN_URL)

          **Merge commit message (full):**

          \`\`\`
          $COMMIT_MSG
          \`\`\`
          EOF
          
          # Move to target, configure git
          cd gpac
          mkdir -p "$TARGET_DIR"
          AUTHOR_NAME="${{ github.event.head_commit.author.name }}"
          AUTHOR_EMAIL="${{ github.event.head_commit.author.email }}"

          if [ -z "$AUTHOR_NAME" ]; then AUTHOR_NAME="${{ github.actor }}"; fi
          if [ -z "$AUTHOR_EMAIL" ]; then
            AUTHOR_EMAIL="${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
          fi

          git config user.name "$AUTHOR_NAME"
          git config user.email "$AUTHOR_EMAIL"
          git checkout -b $BRANCH_NAME

          # Replace old files with new build
          cp -r ../release/* "$TARGET_DIR"/

          # Commit if changes exist
          if [[ -n "$(git status --porcelain)" ]]; then
            git add "$TARGET_DIR"/*
            git commit -m "gpac_monitor: update to gpac_monitor@$SHORT_SHA" \
            -m "$COMMIT_MSG" \
            -m "[noCI]"
            git push origin $BRANCH_NAME

            # Create the PR
            gh pr create \
              --title "gpac_monitor: update $SHORT_SHA" \
              --body-file ../pr_description.md \
              --base master \
              --head $BRANCH_NAME \
              --repo gpac/gpac
          else
            echo "No changes detected, skipping PR."
          fi
